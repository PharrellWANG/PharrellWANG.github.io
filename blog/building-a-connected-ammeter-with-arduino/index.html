<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charSet="utf-8" class="next-head next-head"/><title class="jsx-364176267 jsx-364176267 next-head">Building a Connected Ammeter with Arduino</title><meta name="description" content="This is my experience on building a connected Ammeter with Arduino." class="jsx-364176267 jsx-364176267 next-head"/><link rel="preload" href="/_next/aae20bda-1360-429a-b40e-75e5a415dd46/page/blog/building-a-connected-ammeter-with-arduino.js" as="script"/><link rel="preload" href="/_next/aae20bda-1360-429a-b40e-75e5a415dd46/page/_error.js" as="script"/><link rel="preload" href="/_next/aae20bda-1360-429a-b40e-75e5a415dd46/main.js" as="script"/><style id="jss-server-side"></style><style id="__jsx-1319436554">.jsx-1319436554{margin:15px 0;}</style><style id="__jsx-1221164359">.container.jsx-1221164359{text-align:center;max-width:100%;margin:50px 0;}img.jsx-1221164359{max-width:100%;}.title.jsx-1221164359{color:#888;font-size:13px;line-height:17px;padding:5px 0;}.title.jsx-1221164359 div.jsx-1221164359{margin:0;}</style><style id="__jsx-124958280">.code.jsx-124958280{margin:30px 0;}</style><style id="__jsx-3732062809">span.jsx-3732062809{font-family:'SFMono-Regular',Consolas,'Liberation Mono',Menlo, Courier,monospace;padding:2px 5px;margin:0;font-size:85%;background-color:#f5f5f5;border-radius:3px;}</style><style id="__jsx-2887927494">.spanPaddingRight.jsx-364176267{display:block;margin:0 auto 0 auto;max-width:650px;padding:0 21px;}.span.jsx-364176267{padding-left:30px;}.backIcon.jsx-364176267{padding-right:6px;}a.jsx-364176267{color:#fff;-webkit-text-decoration:none;text-decoration:none;opacity:1;}a.jsx-364176267:hover{color:#fefefe;-webkit-text-decoration:none;text-decoration:none;opacity:0.6;}.footerWrapper.jsx-364176267{margin-top:72px;background:#f2f2f2;height:120px;z-index:1100;}.copyright.jsx-364176267{-webkit-flex:1;-ms-flex:1;flex:1;padding-top:36px;text-align:center;}.headerTop.jsx-364176267{padding-top:21px;padding-bottom:21px;background-color:#333;}.outerContainer.jsx-364176267{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background-color:#fafafa;width:100%;height:100%;}.innerContainer.jsx-364176267{padding:0 21px;-webkit-flex:1;-ms-flex:1;flex:1;}.content.jsx-364176267{margin:0 auto 0 auto;max-width:650px;padding-top:24px;}.content.jsx-364176267 h1.jsx-364176267{font-size:2.125rem;font-weight:500;font-family:Roboto,Helvetica,Arial,sans-serif;line-height:1.15417em;color:rgba(0,0,0,0.54);}.date.jsx-364176267{color:#888;font-size:13px;padding-top:3px;}.markdown-content.jsx-364176267{margin:50px 0 0 0;}</style><style id="__jsx-1095102180">.markdown-content{color:rgba(0,0,0,0.87);line-height:1.46429em;font-size:1.115rem;font-weight:400;}.markdown-content hr{border:0;border-bottom:1px solid #8bc34a;margin:40px 60px;}.markdown-content a{color:#1e88e5;-webkit-text-decoration:none;text-decoration:none;border-bottom:1px solid #1e88e5;}.markdown-content strong{font-weight:500;-webkit-text-decoration:none;text-decoration:none;}.markdown-content li{margin:10px 0;font-size:1rem;}.markdown-content h2{font-size:1.45rem;font-weight:500;font-family:Roboto,Helvetica,Arial,sans-serif;line-height:1.15417em;color:rgba(0,0,0,0.87);}.markdown-content h3{font-size:1.2rem;font-weight:500;font-family:Roboto,Helvetica,Arial,sans-serif;line-height:1.15417em;text-transform:uppercase;color:rgba(0,0,0,0.87);}.markdown-content blockquote{padding:1px 0 1px 15px;margin:0;border-left:5px solid #8bc34a;}</style><style id="__jsx-1580160015"></style><style id="__jsx-3994937953">body{font-family:Roboto,-apple-system,BlinkMacSystemFont,'Segoe UI', Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji', 'Segoe UI Symbol';padding:0;margin:0;-webkit-font-smoothing:antialiased;}</style><title>Pharrell&#x27;s Website</title><meta charSet="utf-8"/><meta name="viewport" content="user-scalable=0, initial-scale=1, minimum-scale=1, width=device-width, height=device-height"/><meta name="theme-color" content="#333"/><link rel="favicon.ico" sizes="512x512" href="/static/favicons/favicon.ico"/><link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/icon-152x152.png"/><link rel="apple-touch-icon" sizes="167x167" href="/static/favicons/icon-167x167.png"/><link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/icon-180x180.png"/><link rel="apple-touch-icon" sizes="192x192" href="/static/favicons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="384x384" href="/static/favicons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/static/favicons/icon-512x512.png"/><link rel="icon" type="image/png" href="/static/favicons/favicon.ico" sizes="512x512"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500"/><link href="https://fonts.googleapis.com/css?family=Kalam" rel="stylesheet"/></head><body><div id="__next"><div class="jsx-4078088743 jsx-4078088743" data-reactroot=""><article class="jsx-4078088743 jsx-4078088743"><main class="jsx-364176267 jsx-364176267 outerContainer"><div class="jsx-364176267 jsx-364176267 headerTop"><span class="jsx-364176267 jsx-364176267 spanPaddingRight"><a href="/blog" class="jsx-364176267 jsx-364176267">&lt; Back</a></span></div><div class="jsx-364176267 jsx-364176267 innerContainer"><div class="jsx-364176267 jsx-364176267 content"><div class="jsx-364176267 jsx-364176267 date">Published on <!-- -->November 11, 2017</div><h1 class="jsx-364176267 jsx-364176267">Building a Connected Ammeter with Arduino</h1><div class="jsx-364176267 jsx-364176267 markdown-content"><div class="_markdown_"><div class="jsx-1319436554 jsx-1319436554">As I continue my electronic experiments, I wanted to measure the current used by <a href="https://en.wikipedia.org/wiki/ESP8266">ESP8266</a> at its different stages. I didn’t wanna just look at numbers, but visualize the current via graphs. The current range I wanted to measure is from 120mA to 30uA. At the end, I wanted a graph like this:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/32688859-d43fd440-c6fe-11e7-8eb7-ad428a13c47c.png" width="100%" class="jsx-1221164359 jsx-1221164359"/></div></div><h2>Measuring the voltage with Arduino</h2><div class="jsx-1319436554 jsx-1319436554"><a href="https://www.arduino.cc/">Arduino</a> has a set of pins which we can use to measure the voltage. We can measure up to 5V in a range of 1024 values. Therefore, the voltage resolution is basically around 5 mv (5000mv/1024).</div><div class="jsx-1319436554 jsx-1319436554">This is my Arduino setup:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/32688884-3e7c1c38-c6ff-11e7-9763-575a486d165d.png" width="100%" class="jsx-1221164359 jsx-1221164359"/></div></div><div class="jsx-1319436554 jsx-1319436554">Here&#x27;s the code:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code><span><span style="color:#a71d5d">void</span> <span style="color:#795da3">setup</span><span>()</span> </span>{
  Serial.begin(<span>9600</span>);
}

<span><span style="color:#a71d5d">float</span> <span style="color:#795da3">toVolt</span><span>(<span style="color:#a71d5d">int</span> val)</span> </span>{
  <span style="color:#a71d5d">return</span> (val/<span>1024.0</span>) * <span>5.0</span>;
}

<span><span style="color:#a71d5d">void</span> <span style="color:#795da3">loop</span><span>()</span> </span>{
  <span style="color:#a71d5d">float</span> a6 = toVolt(analogRead(<span>6</span>));
  <span style="color:#a71d5d">float</span> a7 = toVolt(analogRead(<span>7</span>));

  <span style="color:#a71d5d">float</span> i = ((a6 - a7) / <span>100.0</span>) * <span>1000000</span>;
  Serial.println(String(i) + <span style="color:#df5000">&quot;uA&quot;</span>);

  delay(<span>250</span>);
}</code></pre></div></div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code><span><span style="color:#a71d5d">class</span> <span style="color:#795da3">ListOfAllLenders</span><span>(APIView)</span>:</span>
  <span style="color:#df5000">&quot;&quot;&quot;Provide data for admin loan management page
  &quot;&quot;&quot;</span>
  
  throttle_classes = ()
  <span style="color:#969896"># permission_classes = []</span>
  permission_classes = [permissions.IsAuthenticated, TokenHasScope]
  required_scopes = [<span style="color:#df5000">&#x27;admin&#x27;</span>]
  parser_classes = (
  parsers.FormParser, parsers.MultiPartParser, parsers.JSONParser,)
  renderer_classes = (renderers.JSONRenderer,)
  
  <span><span style="color:#a71d5d">def</span> <span style="color:#795da3">get</span><span>(self, request, *args, **kwargs)</span>:</span>
  <span style="color:#969896"># ============================================================ #</span>
  <span style="color:#969896"># no_of_lenders = ZwapUser.objects.filter(groups__name=&#x27;lender&#x27;).count()</span>
  lenders = ZwapUser.objects.filter(groups__name=<span style="color:#df5000">&#x27;lender&#x27;</span>).order_by(<span style="color:#df5000">&#x27;-date_joined&#x27;</span>)
  <span style="color:#969896"># lenders = lenders.ordered_by(&#x27;-id&#x27;)</span>
  lender_count = lenders.count()
  data_for_rows = []
  <span style="color:#a71d5d">for</span> lender <span style="color:#a71d5d">in</span> lenders:
    this_up = UserProfile.objects.get(user=lender)
    user_id = lender.id
    user_email = lender.email
    user_account_status = lender.getAccountStatus()
    lender_application_status = lender.getLenderStatus()
    is_lender_verified = this_up.is_lender_verified()
    this_user_info = this_up.lender_info
    <span style="color:#a71d5d">if</span> this_user_info <span style="color:#a71d5d">is</span> <span style="color:#a71d5d">None</span>:
      lender_type = <span style="color:#df5000">&#x27;N/A&#x27;</span>
      name = <span style="color:#df5000">&#x27;N/A&#x27;</span>
      gender = <span style="color:#df5000">&#x27;N/A&#x27;</span>
      birthday = <span style="color:#df5000">&#x27;N/A&#x27;</span>
      mobile = <span style="color:#df5000">&#x27;N/A&#x27;</span>
    <span style="color:#a71d5d">else</span>:
      lender_type = this_user_info[<span style="color:#df5000">&#x27;lenderType&#x27;</span>]
      name = this_user_info[<span style="color:#df5000">&#x27;lastName&#x27;</span>] + <span style="color:#df5000">&#x27; &#x27;</span> + this_user_info[<span style="color:#df5000">&#x27;firstName&#x27;</span>]
      gender = this_user_info[<span style="color:#df5000">&#x27;gender&#x27;</span>]
      birthday = this_user_info[<span style="color:#df5000">&#x27;birthday&#x27;</span>]
      mobile = this_user_info[<span style="color:#df5000">&#x27;mobile&#x27;</span>]
    dictionary_item = {
      <span style="color:#df5000">&#x27;userId&#x27;</span>: user_id,
      <span style="color:#df5000">&#x27;email&#x27;</span>: user_email,
      <span style="color:#df5000">&#x27;accountStatus&#x27;</span>: user_account_status,
      <span style="color:#df5000">&#x27;lenderApplicationStatus&#x27;</span>: lender_application_status,
      <span style="color:#df5000">&#x27;verifiedLender&#x27;</span>: <span>1</span> <span style="color:#a71d5d">if</span> is_lender_verified <span style="color:#a71d5d">else</span> <span>0</span>,
      <span style="color:#df5000">&#x27;lenderType&#x27;</span>: lender_type,
      <span style="color:#df5000">&#x27;name&#x27;</span>: name,
      <span style="color:#df5000">&#x27;gender&#x27;</span>: gender,
      <span style="color:#df5000">&#x27;birthday&#x27;</span>: birthday,
      <span style="color:#df5000">&#x27;mobile&#x27;</span>: mobile,
      <span style="color:#df5000">&#x27;lastLogin&#x27;</span>: lender.last_login.astimezone(pytz.timezone(TIME_ZONE)).strftime(<span style="color:#df5000">r&#x27;%d/%m/%Y %H:%M:%S %Z&#x27;</span>) <span style="color:#a71d5d">if</span> lender.last_login <span style="color:#a71d5d">else</span> <span style="color:#df5000">&#x27;N/A&#x27;</span>,
      <span style="color:#df5000">&#x27;penultimateLogin&#x27;</span>: this_up.penultimate_login.astimezone(pytz.timezone(TIME_ZONE)).strftime(<span style="color:#df5000">r&#x27;%d/%m/%Y %H:%M:%S %Z&#x27;</span>) <span style="color:#a71d5d">if</span> this_up.penultimate_login <span style="color:#a71d5d">else</span> <span style="color:#df5000">&#x27;N/A&#x27;</span>,
      <span style="color:#df5000">&#x27;dateJoined&#x27;</span>: lender.date_joined.astimezone(pytz.timezone(TIME_ZONE)).strftime(<span style="color:#df5000">r&#x27;%d/%m/%Y %H:%M:%S %Z&#x27;</span>) <span style="color:#a71d5d">if</span> lender.date_joined <span style="color:#a71d5d">else</span> <span style="color:#df5000">&#x27;N/A&#x27;</span>,
    }
    data_for_rows.append(copy.deepcopy(dictionary_item))
  
  df = pd.DataFrame(
    data_for_rows,
    <span style="color:#969896"># index=list_of_idx,</span>
    columns=[
      <span style="color:#df5000">&#x27;userId&#x27;</span>,
      <span style="color:#df5000">&#x27;email&#x27;</span>,
      <span style="color:#df5000">&#x27;accountStatus&#x27;</span>,
      <span style="color:#df5000">&#x27;lenderApplicationStatus&#x27;</span>,
      <span style="color:#df5000">&#x27;verifiedLender&#x27;</span>,
      <span style="color:#df5000">&#x27;lenderType&#x27;</span>,
      <span style="color:#df5000">&#x27;name&#x27;</span>,
      <span style="color:#df5000">&#x27;gender&#x27;</span>,
      <span style="color:#df5000">&#x27;birthday&#x27;</span>,
      <span style="color:#df5000">&#x27;mobile&#x27;</span>,
      <span style="color:#df5000">&#x27;lastLogin&#x27;</span>,
      <span style="color:#df5000">&#x27;penultimateLogin&#x27;</span>,
      <span style="color:#df5000">&#x27;dateJoined&#x27;</span>,
    ]
  )
  data_for_rows_in_json = df.to_json(orient=<span style="color:#df5000">&#x27;index&#x27;</span>)
  <span style="color:#a71d5d">return</span> Response({
    <span style="color:#df5000">&#x27;status&#x27;</span>: <span>1</span>,
    <span style="color:#df5000">&#x27;data&#x27;</span>: {
      <span style="color:#df5000">&#x27;rowsInJson&#x27;</span>: data_for_rows_in_json,
      <span style="color:#df5000">&#x27;noOfLenders&#x27;</span>: lender_count,
    }})


list_of_all_lenders = ListOfAllLenders.as_view()</code></pre></div></div><div class="jsx-1319436554 jsx-1319436554">Basically, I&#x27;m measuring the voltage between the resistor and applying <span class="jsx-3732062809 jsx-3732062809">I=V/R</span> to calculate the current.</div><div class="jsx-1319436554 jsx-1319436554">It works well. Initially, the accuracy was not that precise. However, I was able to bump up the accuracy by attaching a 5v connection to the <strong>AREF</strong> pin in Arduino. With that, we can tell Arduino to use that voltage as the <a href="https://www.arduino.cc/en/Reference/AnalogReference">reference</a> for <strong>analogRead</strong>.</div><h2>Dashboard</h2><div class="jsx-1319436554 jsx-1319436554">As you&#x27;ve noticed in the above Arduino code, I sent measurements to the serial port every 250ms. Then I wrote a simple <a href="https://github.com/arunoda/ardmeter/tree/master/dashboard">Next.js app</a> to visualize those measurements.</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/32688937-289f0b40-c700-11e7-846a-d656572fe73c.jpg" width="100%" class="jsx-1221164359 jsx-1221164359"/></div></div><div class="jsx-1319436554 jsx-1319436554">It&#x27;s pretty simple and it achieves what I want.</div><h2>Actual Usage</h2><div class="jsx-1319436554 jsx-1319436554">Next, I started using my new ammeter to monitor the current usage of ESP8266. Here&#x27;s my setup:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/32688964-8364b764-c700-11e7-8057-de734b566de2.jpg" width="100%" class="jsx-1221164359 jsx-1221164359"/></div></div><div class="jsx-1319436554 jsx-1319436554">Initially, it failed. I used a 100ohms resistor, where I could measure as low as 50uA of current. I came up with that number by applying <span class="jsx-3732062809 jsx-3732062809">I=V/R</span> and using V as 5mv (which is the minimal voltage Arduino can measure).</div><div class="jsx-1319436554 jsx-1319436554">But it didn&#x27;t work well.</div><div class="jsx-1319436554 jsx-1319436554">The reason is ESP8266 didn&#x27;t get enough voltage to power it up. It needs exactly 3.3v. I used a voltage regulator, but the input to that was 5v. The 100ohms resistor takes a considerable amount of voltage. Hence, the input voltage to the 3.3v voltage regulator was less than 3.3v.</div><div class="jsx-1319436554 jsx-1319436554">I could have used a higher input of voltage like 12v and give it a try, but I didn&#x27;t have a good 12v input source (or I was lazy to find one).</div><h2>Making it Work</h2><div class="jsx-1319436554 jsx-1319436554">I then used a 2ohms resistor and got it working. Then the minimal current I could measure was around 2.5 mA. That was not good enough for me.</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/32688981-d7239ab4-c700-11e7-8a65-ae27726563eb.jpg" width="100%" class="jsx-1221164359 jsx-1221164359"/></div></div><h2>In the End</h2><div class="jsx-1319436554 jsx-1319436554">Basically, Arduino is effective at measuring voltage. But it&#x27;s not good for measuring very low ranges of current.</div><div class="jsx-1319436554 jsx-1319436554">However, I was able to get an idea of the current usage of ESP8266 and that&#x27;s good enough for me (at least for now).</div><div class="jsx-1319436554 jsx-1319436554">My original idea was to build a connected ammeter with some pretty dashboards. But since I can&#x27;t measure very low current, I am not continuing this project. Nevertheless, this was a very nice experiment and I learnt a lot.</div><h2>Next Step</h2><div class="jsx-1319436554 jsx-1319436554">As you already know, high precision ammeters are <a href="https://www.ebay.com/sch/i.html?_sacat=0&amp;_nkw=6.5+digit+multimeter&amp;_frs=1">very expensive</a>. But I found a <a href="https://www.aliexpress.com/item/0-36-5-Digits-0-3-0000A-DC-Ammeter-Digital-amp-Ampere-panel-Meter-Red-LED/32314115899.html?spm=a2g0s.13010208.99999999.263.zNVhzy">cheap</a> ammeter which is good enough in my case.</div><div class="jsx-1319436554 jsx-1319436554">After I got it, I&#x27;d like to test it and connect it my <a href="https://github.com/arunoda/ardmeter/tree/master/dashboard">Next.js powered dashboard</a>. Let’s hope it’ll work well.</div></div></div><button tabindex="0" class="jss16 jss1 jss6 jss11 jss5" type="button" aria-label="scroll-to-top" style="z-index:1800;position:fixed;bottom:24px;top:auto;right:16px;left:auto"><span class="jss2"><svg class="jss19" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><g><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"></path></g></svg></span><span class="jss25"></span></button></div></div><div class="jsx-364176267 jsx-364176267 footerWrapper"><div class="jsx-364176267 jsx-364176267 copyright">© 2018, Pharrell.zx WANG</div></div></main></article></div></div><div id="__next-error"></div><script>
          __NEXT_DATA__ = {"props":{},"page":"/blog/building-a-connected-ammeter-with-arduino","pathname":"/blog/building-a-connected-ammeter-with-arduino","query":{},"buildId":"aae20bda-1360-429a-b40e-75e5a415dd46","assetPrefix":"","nextExport":true,"err":null,"chunks":[]}
          module={}
          __NEXT_LOADED_PAGES__ = []
          __NEXT_LOADED_CHUNKS__ = []

          __NEXT_REGISTER_PAGE = function (route, fn) {
            __NEXT_LOADED_PAGES__.push({ route: route, fn: fn })
          }

          __NEXT_REGISTER_CHUNK = function (chunkName, fn) {
            __NEXT_LOADED_CHUNKS__.push({ chunkName: chunkName, fn: fn })
          }

          false
        </script><script async="" id="__NEXT_PAGE__/blog/building-a-connected-ammeter-with-arduino" src="/_next/aae20bda-1360-429a-b40e-75e5a415dd46/page/blog/building-a-connected-ammeter-with-arduino.js"></script><script async="" id="__NEXT_PAGE__/_error" src="/_next/aae20bda-1360-429a-b40e-75e5a415dd46/page/_error.js"></script><script src="/_next/aae20bda-1360-429a-b40e-75e5a415dd46/main.js" async=""></script></body></html>