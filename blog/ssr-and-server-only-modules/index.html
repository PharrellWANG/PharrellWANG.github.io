<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charSet="utf-8" class="next-head next-head"/><title class="jsx-364176267 jsx-364176267 next-head">SSR and Server Only Modules</title><meta name="description" content="Using server only modules in a SSR enabled app could make your app slower. You need to use them wisely" class="jsx-364176267 jsx-364176267 next-head"/><link rel="preload" href="/_next/695cbe3a-6b5d-4653-aea8-83c96c54ec0c/page/blog/ssr-and-server-only-modules.js" as="script"/><link rel="preload" href="/_next/695cbe3a-6b5d-4653-aea8-83c96c54ec0c/page/_error.js" as="script"/><link rel="preload" href="/_next/695cbe3a-6b5d-4653-aea8-83c96c54ec0c/main.js" as="script"/><style id="jss-server-side"></style><style id="__jsx-1319436554">.jsx-1319436554{margin:15px 0;}</style><style id="__jsx-1221164359">.container.jsx-1221164359{text-align:center;max-width:100%;margin:50px 0;}img.jsx-1221164359{max-width:100%;}.title.jsx-1221164359{color:#888;font-size:13px;line-height:17px;padding:5px 0;}.title.jsx-1221164359 div.jsx-1221164359{margin:0;}</style><style id="__jsx-3732062809">span.jsx-3732062809{font-family:'SFMono-Regular',Consolas,'Liberation Mono',Menlo, Courier,monospace;padding:2px 5px;margin:0;font-size:85%;background-color:#f5f5f5;border-radius:3px;}</style><style id="__jsx-124958280">.code.jsx-124958280{margin:30px 0;}</style><style id="__jsx-2887927494">.spanPaddingRight.jsx-364176267{display:block;margin:0 auto 0 auto;max-width:650px;padding:0 21px;}.span.jsx-364176267{padding-left:30px;}.backIcon.jsx-364176267{padding-right:6px;}a.jsx-364176267{color:#fff;-webkit-text-decoration:none;text-decoration:none;opacity:1;}a.jsx-364176267:hover{color:#fefefe;-webkit-text-decoration:none;text-decoration:none;opacity:0.6;}.footerWrapper.jsx-364176267{margin-top:72px;background:#f2f2f2;height:120px;z-index:1100;}.copyright.jsx-364176267{-webkit-flex:1;-ms-flex:1;flex:1;padding-top:36px;text-align:center;}.headerTop.jsx-364176267{padding-top:21px;padding-bottom:21px;background-color:#333;}.outerContainer.jsx-364176267{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background-color:#fafafa;width:100%;height:100%;}.innerContainer.jsx-364176267{padding:0 21px;-webkit-flex:1;-ms-flex:1;flex:1;}.content.jsx-364176267{margin:0 auto 0 auto;max-width:650px;padding-top:24px;}.content.jsx-364176267 h1.jsx-364176267{font-size:2.125rem;font-weight:500;font-family:Roboto,Helvetica,Arial,sans-serif;line-height:1.15417em;color:rgba(0,0,0,0.54);}.date.jsx-364176267{color:#888;font-size:13px;padding-top:3px;}.markdown-content.jsx-364176267{margin:50px 0 0 0;}</style><style id="__jsx-1095102180">.markdown-content{color:rgba(0,0,0,0.87);line-height:1.46429em;font-size:1.115rem;font-weight:400;}.markdown-content hr{border:0;border-bottom:1px solid #8bc34a;margin:40px 60px;}.markdown-content a{color:#1e88e5;-webkit-text-decoration:none;text-decoration:none;border-bottom:1px solid #1e88e5;}.markdown-content strong{font-weight:500;-webkit-text-decoration:none;text-decoration:none;}.markdown-content li{margin:10px 0;font-size:1rem;}.markdown-content h2{font-size:1.45rem;font-weight:500;font-family:Roboto,Helvetica,Arial,sans-serif;line-height:1.15417em;color:rgba(0,0,0,0.87);}.markdown-content h3{font-size:1.2rem;font-weight:500;font-family:Roboto,Helvetica,Arial,sans-serif;line-height:1.15417em;text-transform:uppercase;color:rgba(0,0,0,0.87);}.markdown-content blockquote{padding:1px 0 1px 15px;margin:0;border-left:5px solid #8bc34a;}</style><style id="__jsx-1580160015"></style><style id="__jsx-3994937953">body{font-family:Roboto,-apple-system,BlinkMacSystemFont,'Segoe UI', Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji', 'Segoe UI Symbol';padding:0;margin:0;-webkit-font-smoothing:antialiased;}</style><title>Pharrell&#x27;s Website</title><meta charSet="utf-8"/><meta name="viewport" content="user-scalable=0, initial-scale=1, minimum-scale=1, width=device-width, height=device-height"/><meta name="theme-color" content="#333"/><link rel="favicon.ico" sizes="512x512" href="/static/favicons/favicon.ico"/><link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/icon-152x152.png"/><link rel="apple-touch-icon" sizes="167x167" href="/static/favicons/icon-167x167.png"/><link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/icon-180x180.png"/><link rel="apple-touch-icon" sizes="192x192" href="/static/favicons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="384x384" href="/static/favicons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/static/favicons/icon-512x512.png"/><link rel="icon" type="image/png" href="/static/favicons/favicon.ico" sizes="512x512"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500"/><link href="https://fonts.googleapis.com/css?family=Kalam" rel="stylesheet"/></head><body><div id="__next"><div class="jsx-4078088743 jsx-4078088743" data-reactroot=""><article class="jsx-4078088743 jsx-4078088743"><main class="jsx-364176267 jsx-364176267 outerContainer"><div class="jsx-364176267 jsx-364176267 headerTop"><span class="jsx-364176267 jsx-364176267 spanPaddingRight"><a href="/blog" class="jsx-364176267 jsx-364176267">&lt;Â Back</a></span></div><div class="jsx-364176267 jsx-364176267 innerContainer"><div class="jsx-364176267 jsx-364176267 content"><div class="jsx-364176267 jsx-364176267 date">Published on <!-- -->June 29, 2017</div><h1 class="jsx-364176267 jsx-364176267">SSR and Server Only Modules</h1><div class="jsx-364176267 jsx-364176267 markdown-content"><div class="_markdown_"><div class="jsx-1319436554 jsx-1319436554">Recently there was an interesting discussion about <a href="https://github.com/zeit/next.js/">Next.js</a>&#x27;s performance on Twitter.</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/28487019-cff64fd2-6ea6-11e7-9b59-f7c2d67bed1f.png" width="450" class="jsx-1221164359 jsx-1221164359"/><div class="jsx-1221164359 jsx-1221164359 title">Screenshot of the tweet without the author info.</div></div></div><div class="jsx-1319436554 jsx-1319436554">Basically, it took about a minute to build the app with <span class="jsx-3732062809 jsx-3732062809">next build</span> and the resulting app&#x27;s bundle was around 1.2 MB.</div><div class="jsx-1319436554 jsx-1319436554">Technically, this is impossible for a simple <a href="https://abc-nfedfcfmoe.now.sh/">hello world</a> Next.js app. Here is what a simple hello world app looks like.</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/28487018-cff49782-6ea6-11e7-8354-724a6ac0e07c.png" width="100%" class="jsx-1221164359 jsx-1221164359"/><div class="jsx-1221164359 jsx-1221164359 title">A simple Next.js app only contains less than 100 KB of content.</div></div></div><div class="jsx-1319436554 jsx-1319436554">Apparently, the mentioned app was using a <strong>server-only</strong> module which caused the issue. That module was only meant to run inside the server, but webpack bundled it.</div><h2>Who is to blame?</h2><div class="jsx-1319436554 jsx-1319436554">Actually, this the wrong question. The question should be the following:</div><div class="jsx-1319436554 jsx-1319436554"><strong>How can we prevent this?</strong></div><div class="jsx-1319436554 jsx-1319436554">Before we answer this question, I need to talk a bit more about some basics.</div><h3>Webpack and NPM modules</h3><div class="jsx-1319436554 jsx-1319436554">Usually, most of the NPM modules we use in client side web apps can be used in both server and client environments. Rarely, we may use some of the server only modules in the client side too. For example, we do this for most of the crypto-based modules.</div><div class="jsx-1319436554 jsx-1319436554">So, webpack always tries to bundle all of the NPM modules as much as it possibly can. It also <a href="https://github.com/webpack/node-libs-browser">comes</a> with a set of NPM modules which implements client side versions of some of the core Node.js modules.</div><h3>Server side rendering (SSR)</h3><div class="jsx-1319436554 jsx-1319436554">SSR is pretty interesting and it runs your client side code in the server. Usually, most of the NPM modules we use could work in both environments.</div><div class="jsx-1319436554 jsx-1319436554">But sometimes, we need to import some NPM modules only to run inside the server.</div><div class="jsx-1319436554 jsx-1319436554">For an example, when <a href="https://github.com/zeit/next.js/#fetching-data-and-component-lifecycle">fetching data</a> in a Next.js app we might use a server only module to fetch data.</div><div class="jsx-1319436554 jsx-1319436554">Have a look at the following code:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code><span style="color:#a71d5d">import</span> React <span style="color:#a71d5d">from</span> <span style="color:#df5000">&#x27;react&#x27;</span>
<span style="color:#a71d5d">import</span> Link <span style="color:#a71d5d">from</span> <span style="color:#df5000">&#x27;next/link&#x27;</span>

<span style="color:#a71d5d">export</span> <span style="color:#a71d5d">default</span> <span><span style="color:#a71d5d">class</span> <span style="color:#795da3">Index</span> <span style="color:#a71d5d">extends</span> <span style="color:#795da3">React</span>.<span style="color:#795da3">Component</span> </span>{
  <span style="color:#a71d5d">static</span> getInitialProps ({ req }) {
    <span style="color:#a71d5d">if</span> (req) {
      <span style="color:#969896">// Runs only in the server</span>
      <span style="color:#a71d5d">const</span> faker = <span>require</span>(<span style="color:#df5000">&#x27;faker&#x27;</span>)
      <span style="color:#a71d5d">const</span> name = faker.name.findName()
      <span style="color:#a71d5d">return</span> { name }
    }

    <span style="color:#969896">// Runs only in the client</span>
    <span style="color:#a71d5d">return</span> { <span style="color:#795da3">name</span>: <span style="color:#df5000">&#x27;Arunoda&#x27;</span> }
  }

  render () {
    <span style="color:#a71d5d">const</span> { name } = <span style="color:#a71d5d">this</span>.props
    <span style="color:#a71d5d">return</span> (
      <span><span style="color:#333333">&lt;<span style="color:#63a35c">div</span>&gt;</span>
        </span>&lt;h1&gt;Home Page&lt;/h1&gt;<span>
        </span>&lt;p&gt;Welcome, {name}&lt;/p&gt;<span>
        </span>&lt;div&gt;
          &lt;Link href=&#x27;/about&#x27;&gt;&lt;a&gt;About Page&lt;/a&gt;&lt;/Link&gt;
        &lt;/div&gt;<span>
      <span style="color:#333333">&lt;/<span style="color:#63a35c">div</span>&gt;</span></span>
    )
  }
}</code></pre></div></div><div class="jsx-1319436554 jsx-1319436554">In the above example, our intention is to use <span class="jsx-3732062809 jsx-3732062809">faker</span> module only in the server.</div><div class="jsx-1319436554 jsx-1319436554">But webpack includes <span class="jsx-3732062809 jsx-3732062809">faker</span> module in client side as well. So, the app&#x27;s bundle size increases and it takes more time to build.</div><h2>How to identify</h2><div class="jsx-1319436554 jsx-1319436554">Frankly, there&#x27;s no simple way to identify this issue. You need to use a webpack analyzer to visualize what&#x27;s inside your bundle.</div><div class="jsx-1319436554 jsx-1319436554">Here&#x27;s a sample Next.js <a href="https://github.com/zeit/next.js/tree/master/examples/with-webpack-bundle-analyzer">app</a> which comes with a <a href="https://github.com/th0r/webpack-bundle-analyzer">webpack analyzer</a>.</div><div class="jsx-1319436554 jsx-1319436554">Download the app and run the following command:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code>npm run analyze</code></pre></div></div><div class="jsx-1319436554 jsx-1319436554">Then it will open a HTML page in the browser and it&#x27;ll look like this:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-1221164359 jsx-1221164359 container"><img src="https://user-images.githubusercontent.com/50838/28487017-cff25bac-6ea6-11e7-9484-8372467903d2.png" width="100%" class="jsx-1221164359 jsx-1221164359"/></div></div><div class="jsx-1319436554 jsx-1319436554">You can clearly see <span class="jsx-3732062809 jsx-3732062809">faker</span> module is included in the client side bundle of the âindex.jsâ page.</div><div class="jsx-1319436554 jsx-1319436554">As shown in the above example app, you can configure <a href="https://github.com/th0r/webpack-bundle-analyzer">webpack-bundle-analyzer</a> with your app and see what&#x27;s included in your client side bundle(s).</div><h2>How to fix it</h2><div class="jsx-1319436554 jsx-1319436554">After you&#x27;ve identified the issue, it&#x27;s pretty easy to fix it. There are few ways to do this.</div><h3>1. Using Eval</h3><div class="jsx-1319436554 jsx-1319436554">You can require the module inside <span class="jsx-3732062809 jsx-3732062809">eval</span> as mentioned below:</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code><span style="color:#a71d5d">const</span> faker = <span>eval</span>(<span style="color:#df5000">&quot;require(&#x27;faker&#x27;)&quot;</span>)</code></pre></div></div><div class="jsx-1319436554 jsx-1319436554">Webpack can&#x27;t statically analyze what&#x27;s inside eval. So it won&#x27;t bundle the <span class="jsx-3732062809 jsx-3732062809">faker</span> module.</div><h3>2. Using Webpack&#x27;s Ignore plugin</h3><div class="jsx-1319436554 jsx-1319436554">Webpack also has a <a href="https://webpack.js.org/plugins/ignore-plugin/">plugin</a> where you can ignore modules. Here&#x27;s how to use it.</div><div class="jsx-1319436554 jsx-1319436554">Create a file called <span class="jsx-3732062809 jsx-3732062809">next.config.js</span> in your Next.js app and add the webpack IgnorePlugin.</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code><span>module</span>.exports = {
  <span style="color:#795da3">webpack</span>: <span><span style="color:#a71d5d">function</span> (<span>config</span>) </span>{
    config.plugins.push(
      <span style="color:#a71d5d">new</span> <span>require</span>(<span style="color:#df5000">&#x27;webpack&#x27;</span>).IgnorePlugin(<span>/faker/</span>)
    )

    <span style="color:#a71d5d">return</span> config
  }
}</code></pre></div></div><blockquote><div class="jsx-1319436554 jsx-1319436554">If you are using webpack directly, just use the plugin directly.</div></blockquote><h3>3. Using the &quot;browser&quot; field of the &quot;package.json&quot;</h3><div class="jsx-1319436554 jsx-1319436554">You can also ask webpack to disable bundling <span class="jsx-3732062809 jsx-3732062809">faker</span> module via adding a config in the main <span class="jsx-3732062809 jsx-3732062809">package.json</span> file.<br/>Add the following code in to your <span class="jsx-3732062809 jsx-3732062809">package.json</span> file.</div><div class="jsx-1319436554 jsx-1319436554"><div class="jsx-124958280 jsx-124958280 code"><pre style="display:block;background:white;padding:15px;color:#333333;overflow-x:auto;font-size:100%;border-radius:8px;background-color:#eeeeee"><code>{
  ...
  <span style="color:#df5000">&quot;browser&quot;</span>: {
    <span style="color:#df5000">&quot;faker&quot;</span>: <span style="color:#0086b3">false</span>
  }
  ...
}</code></pre></div></div><blockquote><div class="jsx-1319436554 jsx-1319436554">Additionally you can use webpack&#x27;s <a href="https://webpack.js.org/configuration/resolve/#resolve-alias"><span class="jsx-3732062809 jsx-3732062809">resolve.alias</span></a> to map <span class="jsx-3732062809 jsx-3732062809">faker</span> into an empty module.</div></blockquote><h2>Lack of tools and awareness</h2><div class="jsx-1319436554 jsx-1319436554">This is a problem we face not only with <a href="https://github.com/zeit/next.js/">Next.js</a>, but with any SSR enabled app (including <a href="https://developers.google.com/web/progressive-web-apps/">PWAs</a>). Normally, most of the developers are not aware of this issue.</div><div class="jsx-1319436554 jsx-1319436554">So we need some better tooling to detect this problem other than manually inspecting the bundle.</div><div class="jsx-1319436554 jsx-1319436554">It&#x27;d be great if we could build a webpack plugin to warn users if webpack sees a server-only module.</div><blockquote><div class="jsx-1319436554 jsx-1319436554">If you want to contribute to webpack, this would be a great start.</div></blockquote><div class="jsx-1319436554 jsx-1319436554">Until then, all we can do is educate developers with posts like this.</div></div></div><button tabindex="0" class="jss16 jss1 jss6 jss11 jss5" type="button" aria-label="scroll-to-top" style="z-index:1800;position:fixed;bottom:24px;top:auto;right:16px;left:auto"><span class="jss2"><svg class="jss19" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><g><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"></path></g></svg></span><span class="jss25"></span></button></div></div><div class="jsx-364176267 jsx-364176267 footerWrapper"><div class="jsx-364176267 jsx-364176267 copyright">Â© 2018, Pharrell.zx WANG</div></div></main></article></div></div><div id="__next-error"></div><script>
          __NEXT_DATA__ = {"props":{},"page":"/blog/ssr-and-server-only-modules","pathname":"/blog/ssr-and-server-only-modules","query":{},"buildId":"695cbe3a-6b5d-4653-aea8-83c96c54ec0c","assetPrefix":"","nextExport":true,"err":null,"chunks":[]}
          module={}
          __NEXT_LOADED_PAGES__ = []
          __NEXT_LOADED_CHUNKS__ = []

          __NEXT_REGISTER_PAGE = function (route, fn) {
            __NEXT_LOADED_PAGES__.push({ route: route, fn: fn })
          }

          __NEXT_REGISTER_CHUNK = function (chunkName, fn) {
            __NEXT_LOADED_CHUNKS__.push({ chunkName: chunkName, fn: fn })
          }

          false
        </script><script async="" id="__NEXT_PAGE__/blog/ssr-and-server-only-modules" src="/_next/695cbe3a-6b5d-4653-aea8-83c96c54ec0c/page/blog/ssr-and-server-only-modules.js"></script><script async="" id="__NEXT_PAGE__/_error" src="/_next/695cbe3a-6b5d-4653-aea8-83c96c54ec0c/page/_error.js"></script><script src="/_next/695cbe3a-6b5d-4653-aea8-83c96c54ec0c/main.js" async=""></script></body></html>